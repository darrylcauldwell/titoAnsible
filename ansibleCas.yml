formatVersion: 1
inputs:
  ansible-key:
    type: string
    default: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCtAXOjcS7Fp7PQv+/w+PzIVOOcunvElIwMi/qEIIsQJpBosNc3xb+x2IqpVg9+/wPmvZRrZR2JEG+pLrnRAshAN4k7tn1qNTodMDi4hbcYw+WDt2eu9I6oD8G1eipuq9pzJQcB+LrhvJORzHdTd9HCJ1z9umcSaH4/ce+6G4H86sC0jF5UY7kwaHRYJgRyH8GWyrV/fjG4PN14kKCSTQi95ppHLG/KtPKkzvJwSMWskTieUfSPC6Fparms1Rf72cAM458RspXqUSYmzvDfRaN7086mlIXxDnQ9OxC2k3XiT6jSl0jzDWZzqkrtLW3DVySxNNKVClDoALUPDbtrTneH root@ansibleserver-mcm679349-112967850675.darrylcauldwell.com
    title: Ansible public SSH key
resources:
  ansibleTitoWeb:
    type: Cloud.Ansible
    properties:
      host: '${resource.titoWeb.*}'
      osType: linux
      account: DC-Ansible
      username: ansible
      privateKeyFile: /root/.ssh/id_rsa
      groups:
        - titoWebserver
      playbooks:
        provision: /etc/ansible/playbooks/titoPlaybook.yml
  titoWeb:
    type: Cloud.Machine
    properties:
      image: ansibleCentOS76
      flavor: ansibleMedium
      cloudConfig: |
        #cloud-config
        output: {all: '| tee -a /var/log/cloud-init-output.log'}
        runcmd:
        - useradd -m -d /home/ansible -s /bin/bash ansible
        - mkdir /home/ansible/.ssh
        - touch /home/ansible/.ssh/authorization_keys
        - echo '${input.ansible-key}' >> /home/ansible/.ssh/authorized_keys
        - echo 'ansible ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
        - echo 'Defaults:ansible !requiretty' >> /etc/sudoers
        - usermod --groups wheel ansible
        - export SQLSERVER='${resource.db-vm.networks[0].address}'
      networks:
        - network: '${resource.net.id}'
  ansibleTitoDb:
    type: Cloud.Ansible
    properties:
      host: '${resource.titoDb.*}'
      osType: linux
      account: DC-Ansible
      username: ansible
      privateKeyFile: /root/.ssh/id_rsa
      groups:
        - titoDatabase
      playbooks:
        provision: /etc/ansible/playbooks/titoPlaybook.yml
  titoDb:
    type: Cloud.Machine
    properties:
      image: ansibleCentOS76
      flavor: ansibleMedium
      cloudConfig: |
        #cloud-config
        output: {all: '| tee -a /var/log/cloud-init-output.log'}
        runcmd:
        - useradd -m -d /home/ansible -s /bin/bash ansible
        - mkdir /home/ansible/.ssh
        - touch /home/ansible/.ssh/authorization_keys
        - echo '${input.ansible-key}' >> /home/ansible/.ssh/authorized_keys
        - echo 'ansible ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
        - echo 'Defaults:ansible !requiretty' >> /etc/sudoers
        - usermod --groups wheel ansible
      networks:
        - network: '${resource.net.id}'
  net:
    type: Cloud.Network
    properties:
      networkType: existing
